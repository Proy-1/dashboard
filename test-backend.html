<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            <i class="fas fa-plug mr-3 text-blue-500"></i>
            Backend Integration Test
        </h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Connection Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-server mr-2 text-green-500"></i>
                    Connection Status
                </h3>
                <div id="connection-status" class="text-gray-600">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Testing connection...
                </div>
            </div>
            
            <!-- API Health -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-heartbeat mr-2 text-red-500"></i>
                    API Health Check
                </h3>
                <div id="health-status" class="text-gray-600">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Checking health...
                </div>
            </div>
            
            <!-- Products Test -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-box mr-2 text-purple-500"></i>
                    Products API Test
                </h3>
                <div id="products-status" class="text-gray-600">
                    <i class="fas fa-spinner fa-spin mr-2"></i> Testing products API...
                </div>
                <button onclick="testCreateProduct()" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-plus mr-1"></i> Test Create Product
                </button>
            </div>
            
            <!-- Upload Test -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-upload mr-2 text-orange-500"></i>
                    Upload Test
                </h3>
                <div id="upload-status" class="text-gray-600">Ready to test upload</div>
                <input type="file" id="test-file" accept="image/*" class="mt-3 w-full">
                <button onclick="testUpload()" class="mt-2 bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    <i class="fas fa-upload mr-1"></i> Test Upload
                </button>
            </div>
        </div>
        
        <!-- Logs -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-list mr-2 text-gray-500"></i>
                Test Logs
            </h3>
            <div id="logs" class="bg-gray-50 p-4 rounded h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">Test logs will appear here...</div>
            </div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script>
        const BASE_URL = 'http://localhost:5000/api';
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600', 
                error: 'text-red-600',
                warning: 'text-orange-600'
            };
            
            logs.innerHTML += `<div class="${colors[type]} mb-1">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Test connection
        async function testConnection() {
            try {
                const response = await fetch(`${BASE_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('connection-status').innerHTML = 
                        '<i class="fas fa-check-circle mr-2 text-green-500"></i> Connected';
                    log('‚úÖ Connection successful', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-times-circle mr-2 text-red-500"></i> Failed to connect';
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Test health endpoint
        async function testHealth() {
            try {
                const response = await fetch(`${BASE_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    document.getElementById('health-status').innerHTML = 
                        '<i class="fas fa-check-circle mr-2 text-green-500"></i> Healthy';
                    log('‚úÖ Health check passed', 'success');
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                document.getElementById('health-status').innerHTML = 
                    '<i class="fas fa-times-circle mr-2 text-red-500"></i> Unhealthy';
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }
        
        // Test products API
        async function testProducts() {
            try {
                const response = await fetch(`${BASE_URL}/products`);
                const products = await response.json();
                
                document.getElementById('products-status').innerHTML = 
                    `<i class="fas fa-check-circle mr-2 text-green-500"></i> ${products.length} products found`;
                log(`‚úÖ Products API working: ${products.length} products`, 'success');
            } catch (error) {
                document.getElementById('products-status').innerHTML = 
                    '<i class="fas fa-times-circle mr-2 text-red-500"></i> API Error';
                log(`‚ùå Products API failed: ${error.message}`, 'error');
            }
        }
        
        // Test create product
        async function testCreateProduct() {
            try {
                const testProduct = {
                    name: 'Test Product ' + Date.now(),
                    price: 100000,
                    description: 'Test product dari integration test',
                    image_url: ''
                };
                
                const response = await fetch(`${BASE_URL}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testProduct)
                });
                
                if (response.ok) {
                    const product = await response.json();
                    log(`‚úÖ Test product created: ${product.name}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Create product failed: ${error.message}`, 'error');
            }
        }
        
        // Test upload
        async function testUpload() {
            const fileInput = document.getElementById('test-file');
            if (!fileInput.files[0]) {
                log('‚ö†Ô∏è Please select a file first', 'warning');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                
                document.getElementById('upload-status').innerHTML = 
                    '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
                
                const response = await fetch(`${BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('upload-status').innerHTML = 
                        '<i class="fas fa-check-circle mr-2 text-green-500"></i> Upload successful';
                    log(`‚úÖ File uploaded: ${result.image_url}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('upload-status').innerHTML = 
                    '<i class="fas fa-times-circle mr-2 text-red-500"></i> Upload failed';
                log(`‚ùå Upload failed: ${error.message}`, 'error');
            }
        }
        
        // Run tests on load
        window.addEventListener('DOMContentLoaded', async function() {
            log('üöÄ Starting backend integration tests...', 'info');
            
            await testConnection();
            await testHealth();
            await testProducts();
            
            log('‚ú® Tests completed. Check results above.', 'info');
        });
    </script>
</body>
</html>
